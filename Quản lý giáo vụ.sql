--QUAN LY GIAO VU

CREATE DATABASE QUAN_LY_GIAO_VU
USE QUAN_LY_GIAO_VU

--PHAN I QUAN LY GIAO VU

CREATE TABLE KHOA (
	MAKHOA varchar(4) NOT NULL PRIMARY KEY,
	TENKHOA varchar(40),
	NGTLAP smalldatetime,
	TRGKHOA char(4)
)
CREATE TABLE MONHOC (
	MAMH varchar(10) NOT NULL PRIMARY KEY,
	TENMH varchar(40),
	TCLT tinyint,
	TCTH tinyint,
	MAKHOA varchar(4) FOREIGN KEY REFERENCES KHOA(MAKHOA)
)
CREATE TABLE DIEUKIEN (
	MAMH varchar(10) FOREIGN KEY REFERENCES MONHOC(MAMH),
	MAMH_TRUOC varchar(10)FOREIGN KEY REFERENCES MONHOC(MAMH),
	CONSTRAINT PK_DIEUKIEN PRIMARY KEY (MAMH, MAMH_TRUOC)
)
CREATE TABLE GIAOVIEN (
	MAGV char(4) NOT NULL PRIMARY KEY,
	HOTEN varchar(40),
	HOCVI varchar(40), HOCHAM varchar(40),
	GIOITINH varchar(3),
	NGSINH smalldatetime, NGVL smalldatetime,
	HESO numeric(4,2) , 
	MUCLUONG money,
	MAKHOA varchar(4) FOREIGN KEY REFERENCES KHOA(MAKHOA)
)
CREATE TABLE HOCVIEN(
	MAHV char(5) NOT NULL PRIMARY KEY,
	HO varchar(50) ,
	TEN varchar(50),
	NGSINH smalldatetime,
	GIOITINH varchar(3),
	NOISINH varchar(40),
	MALOP char(3)
)
CREATE TABLE LOP(
	MALOP char(3) NOT NULL PRIMARY KEY,
	TENLOP varchar(40),
	TRGLOP char(5) FOREIGN KEY REFERENCES HOCVIEN(MAHV),
	SISO tinyint,
	MAGVCN char(4) FOREIGN KEY REFERENCES GIAOVIEN(MAGV)
)
CREATE TABLE GIANGDAY (
	MALOP char(3) FOREIGN KEY REFERENCES LOP(MALOP),
	MAMH varchar(10) FOREIGN KEY REFERENCES MONHOC(MAMH),
	MAGV char(4) FOREIGN KEY REFERENCES GIAOVIEN(MAGV),
	HOCKY tinyint,
	NAM smallint,
	TUNGAY smalldatetime, DENNGAY smalldatetime,
	CONSTRAINT PK_GIANGDAY PRIMARY KEY (MALOP, MAMH)
)
CREATE TABLE KETQUATHI (
	MAHV char(5) FOREIGN KEY REFERENCES HOCVIEN(MAHV),
	MAMH varchar(10) FOREIGN KEY REFERENCES MONHOC(MAMH),
	LANTHI tinyint,
	NGTHI smalldatetime,
	DIEM numeric(4,2),
	KQUA varchar(10),
	CONSTRAINT PK_KETQUATHI PRIMARY KEY (MAHV, MAMH, LANTHI)
)
ALTER TABLE HOCVIEN ADD GHICHU varchar(100)
ALTER TABLE HOCVIEN ADD DIEMTB numeric(4,2)
ALTER TABLE HOCVIEN ADD XEPLOAI varchar(20)
--3.	Thuộc tính GIOITINH chỉ có giá trị là “Nam” hoặc “Nu”.
ALTER TABLE GIAOVIEN
ADD CONSTRAINT GIAOVIEN_GIOITINH CHECK(GIOITINH = 'Nam' OR GIOITINH = 'Nu')
ALTER TABLE HOCVIEN
ADD CONSTRAINT HOCVIEN_GIOITINH CHECK(GIOITINH = 'Nam' OR GIOITINH = 'Nu')
--4.	Điểm số của một lần thi có giá trị từ 0 đến 10 và cần lưu đến 2 số lẽ (VD: 6.22).
ALTER TABLE KETQUATHI
ADD CONSTRAINT KETQUATHI_DIEM CHECK(DIEM >= 0 AND DIEM <= 10)
--5.	Kết quả thi là “Dat” nếu điểm từ 5 đến 10  và “Khong dat” nếu điểm nhỏ hơn 5.
ALTER TABLE KETQUATHI
ADD CONSTRAINT KETQUATHI_KETQUA CHECK ((DIEM >= 5 AND DIEM <= 10 AND KQUA='Dat')OR(DIEM >= 0 AND DIEM < 5 AND KQUA='Khong Dat'))
--6.	Học viên thi một môn tối đa 3 lần.
ALTER TABLE KETQUATHI
ADD CONSTRAINT KETQUATHI_LANTHI CHECK(LANTHI <= 3)
 --7.	Học kỳ chỉ có giá trị từ 1 đến 3.
 ALTER TABLE GIANGDAY
 ADD CONSTRAINT GIANGDAY_HOCKY CHECK(HOCKY >= 1 AND HOCKY <= 3)
 --8.	Học vị của giáo viên chỉ có thể là “CN”, “KS”, “Ths”, ”TS”, ”PTS”.
 ALTER TABLE GIAOVIEN
 ADD CONSTRAINT GIAOVIEN_HOCVI CHECK(HOCVI = 'CN' OR HOCVI = 'KS' OR HOCVI = 'Ths' OR HOCVI = 'TS' OR HOCVI = 'PTS')
-- 9.	Lớp trưởng của một lớp phải là học viên của lớp đó.
CREATE TRIGGER TRG_INS_LT ON LOP
FOR INSERT
AS
BEGIN
	IF NOT EXISTS( SELECT *
		FROM inserted, HOCVIEN
		WHERE inserted.TRGLOP = HOCVIEN.MAHV 
		AND inserted.MALOP = HOCVIEN.MALOP)
	BEGIN
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END

--10.	Trưởng khoa phải là giáo viên thuộc khoa và có học vị “TS” hoặc “PTS”.
CREATE TRIGGER TRG_INS_TK ON KHOA
FOR INSERT
AS
BEGIN
	IF NOT EXISTS(SELECT *
		FROM GIAOVIEN, inserted
		WHERE GIAOVIEN.MAKHOA = inserted.MAKHOA
		AND GIAOVIEN.MAGV = inserted.TRGKHOA
		AND GIAOVIEN.HOCVI = 'TS' 
		OR GIAOVIEN.HOCVI = 'PTS')
	BEGIN
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END

--15.	Học viên chỉ được thi một môn học nào đó khi lớp của học viên đã học xong môn học này.
CREATE TRIGGER TRG_INS_HV ON HOCVIEN
FOR INSERT
AS
BEGIN
	IF NOT EXISTS(SELECT * 
		FROM GIANGDAY, inserted, KETQUATHI
		WHERE inserted.MALOP = GIANGDAY.MALOP
		AND inserted.MAHV = KETQUATHI.MAHV
		AND GIANGDAY.MAMH = KETQUATHI.MAMH
		AND GIANGDAY.DENNGAY <= KETQUATHI.NGTHI)
	BEGIN
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END

--16.	Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.
CREATE TRIGGER TRG_INS_LOP ON LOP
FOR INSERT
AS
BEGIN
	IF NOT EXISTS(SELECT HOCKY, NAM
		FROM inserted, GIANGDAY, MONHOC
		WHERE inserted.MALOP = GIANGDAY.MALOP
		AND GIANGDAY.MAMH = MONHOC.MAMH
		GROUP BY HOCKY, NAM
		HAVING COUNT(DISTINCT GIANGDAY.MAMH) <= 3)
	BEGIN
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END

--17.	Sỉ số của một lớp bằng với số lượng học viên thuộc lớp đó.
CREATE TRIGGER TRG_INS_SS ON LOP
FOR INSERT
AS
BEGIN
	IF NOT EXISTS(SELECT *
		FROM inserted, HOCVIEN
		WHERE inserted.MALOP = HOCVIEN.MALOP
		AND SISO = COUNT(DISTINCT MAHV))
	BEGIN
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END

--19.	Các giáo viên có cùng học vị, học hàm, hệ số lương thì mức lương bằng nhau.
CREATE TRIGGER TRG_NIS_GV ON GIAOVIEN
FOR INSERT
AS
BEGIN
	IF NOT EXISTS(SELECT HOCVI, HOCHAM, MUCLUONG
		FROM inserted
		GROUP BY HOCHAM, HOCVI, MUCLUONG)
	BEGIN
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END
--20.	Học viên chỉ được thi lại (lần thi >1) khi điểm của lần thi trước đó dưới 5.
CREATE TRIGGER TRG_INS_HV ON HOCVIEN
FOR INSERT
AS
BEGIN
	IF NOT EXISTS(SELECT *
		FROM inserted, KETQUATHI
		WHERE inserted.MAHV = KETQUATHI.MAHV
		AND LANTHI >= 1
		AND DIEM < 5 )
	BEGIN 
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END
--21.	Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước.
CREATE TRIGGER TRG_INS_NT ON KETQUATHI
FOR CREATE
AS
BEGIN
	IF EXISTS(SELECT NGTHI, LANTHI
		FROM inserted, HOCVIEN, MONHOC
		WHERE HOCVIEN.MAHV = inserted.MAHV
		AND inserted.MAMH = MONHOC.MAMH
		AND LANTHI > 1
	BEGIN
		PRINT 'HOP LE'
	END
	ELSE
	BEGIN
		PRINT 'KHONG HOP LE'
		ROLLBACK TRANSACTION
	END
END

--23.	Giáo viên chỉ được phân công dạy những môn thuộc khoa giáo viên đó phụ trách.
CREATE TRIGGER TRG_INS_GV ON GIAOVIEN
FOR INSERT
AS
BEGIN
	IF NOT EXISTS(SELECT *
		FROM KHOA, inserted, MONHOC, GIANGDAY
		WHERE inserted.MAKHOA = KHOA.MAKHOA
		AND KHOA.MAKHOA = MONHOC.MAKHOA
		AND GIANGDAY.MAGV = inserted.MAGV
		AND GIANGDAY.MAMH = MONHOC.MAMH)
	BEGIN
		PRINT 'KHONG HOP LE'
	END
	ELSE
	BEGIN
		PRINT 'THANH CONG'
	END
END

SET DATEFORMAT DMY;
INSERT INTO DIEUKIEN VALUES('CSDL', 'CTRR')
INSERT INTO DIEUKIEN VALUES('CSDL', 'CTDLGT')
INSERT INTO DIEUKIEN VALUES('CTDLGT', 'THDC')
INSERT INTO DIEUKIEN VALUES('PTTKTT', 'THDC')
INSERT INTO DIEUKIEN VALUES('PTTKTT', 'CTDLGT')
INSERT INTO DIEUKIEN VALUES('DHMT', 'THDC')
INSERT INTO DIEUKIEN VALUES('LTHDT', 'THDC')
INSERT INTO DIEUKIEN VALUES('PTTKHTTT', 'CSDL')

INSERT INTO KHOA VALUES('KHMT', 'Khoa hoc may tinh', '7/6/2005', 'GV01')							
INSERT INTO KHOA VALUES('HTTT', 'He thong thong tin', '7/6/2005', 'GV02')							
INSERT INTO KHOA VALUES('CNPM', 'Cong nghe phan mem', '7/6/2005', 'GV04')							
INSERT INTO KHOA VALUES('MTT', 'Mang va truyen thong', '20/10/2005', 'GV03')							
INSERT INTO KHOA VALUES('KTMT', 'Ky thuat may tinh', '20/12/2005', 'Null')							

INSERT INTO LOP VALUES('K11', 'Lop 1 khoa 1', 'K1108', '11','GV07')				
INSERT INTO LOP VALUES('K12', 'Lop 2 khoa 1', 'K1205', '12','GV09')				
INSERT INTO LOP VALUES('K13', 'Lop 3 khoa 1', 'K1305', '12','GV14')	

INSERT INTO MONHOC VALUES('THDC', 'Tin hoc dai cuong', '4', '1', 'KHMT')					
INSERT INTO MONHOC VALUES('CTRR', 'Cau truc roi rac', '5', '2', 'KHMT')					
INSERT INTO MONHOC VALUES('CSDL', 'Co so du lieu', '3', '1', 'HTTT')					
INSERT INTO MONHOC VALUES('CTDLGT', 'Cau truc du lieu va giai thuat', '3', '1', 'KHMT')					
INSERT INTO MONHOC VALUES('PTTKTT', 'Phan tich thiet ke thuat toan', '3', '0', 'KHMT')					
INSERT INTO MONHOC VALUES('DHMT', 'Do hoa may tinh', '3', '1', 'KHMT')					
INSERT INTO MONHOC VALUES('KTMT', 'Kien truc may tinh', '3', '0', 'KTMT')					
INSERT INTO MONHOC VALUES('TKCSDL', 'Thiet ke co so du lieu', '3', '1', 'HTTT')					
INSERT INTO MONHOC VALUES('PTTKHTTT', 'Phan tich thiet ke he thong thong tin', '4', '1', 'HTTT')					
INSERT INTO MONHOC VALUES('HDH', 'He dieu hanh', '4', '1', 'KTMT')					
INSERT INTO MONHOC VALUES('NMCNPM', 'Nhap mon cong nghe phan mem', '3', '0', 'CNPM')					
INSERT INTO MONHOC VALUES('LTCFW', 'Lap trinh C for win', '3', '1', 'CNPM')					
INSERT INTO MONHOC VALUES('LTHDT', 'Lap trinh huong doi tuong', '3', '1', 'CNPM')						

INSERT INTO GIANGDAY VALUES('K11', 'THDC', 'GV07', '1', '2006','2/1/2006', '12/5/2006')					
INSERT INTO GIANGDAY VALUES('K12', 'THDC', 'GV06', '1', '2006','2/1/2006', '12/5/2006')					
INSERT INTO GIANGDAY VALUES('K13', 'THDC', 'GV15', '1', '2006','2/1/2006', '12/5/2006')					
INSERT INTO GIANGDAY VALUES('K11', 'CTRR', 'GV02', '1', '2006','9/1/2006', '17/5/2006')					
INSERT INTO GIANGDAY VALUES('K12', 'CTRR', 'GV02', '1', '2006','9/1/2006', '17/5/2006')					
INSERT INTO GIANGDAY VALUES('K13', 'CTRR', 'GV08', '1', '2006','9/1/2006', '17/5/2006')					
INSERT INTO GIANGDAY VALUES('K11', 'CSDL', 'GV05', '2', '2006','1/6/2006', '15/7/2006')					
INSERT INTO GIANGDAY VALUES('K12', 'CSDL', 'GV09', '2', '2006','1/6/2006', '15/7/2006')					
INSERT INTO GIANGDAY VALUES('K13', 'CTDLGT', 'GV15', '2', '2006','1/6/2006', '15/7/2006')					
INSERT INTO GIANGDAY VALUES('K13', 'CSDL', 'GV05', '3', '2006','1/8/2006', '15/12/2006')					
INSERT INTO GIANGDAY VALUES('K13', 'DHMT', 'GV07', '3', '2006','1/8/2006', '15/12/2006')					
INSERT INTO GIANGDAY VALUES('K11', 'CTDLGT', 'GV15', '3', '2006','1/8/2006', '15/12/2006')					
INSERT INTO GIANGDAY VALUES('K12', 'CTDLGT', 'GV15', '3', '2006','1/8/2006', '15/12/2006')					
INSERT INTO GIANGDAY VALUES('K11', 'HDH', 'GV04', '1', '2007','2/1/2007', '18/2/2007')					
INSERT INTO GIANGDAY VALUES('K12', 'HDH', 'GV04', '1', '2007','2/1/2007', '20/3/2007')					
INSERT INTO GIANGDAY VALUES('K11', 'DHMT', 'GV07', '1', '2007','18/2/2007', '20/3/2007')		

INSERT INTO GIAOVIEN VALUES('GV01', 'Ho Thanh Son', 'PTS', 'GS', 'Nam', '2/5/1950', '11/1/2004', '5.00', '2,250,000', 'KHMT')							
INSERT INTO GIAOVIEN VALUES('GV02', 'Tran Tam Thanh', 'TS', 'PGS', 'Nam', '17/12/1965', '20/4/2004', '4.50', '2,025,000', 'HTTT')							
INSERT INTO GIAOVIEN VALUES('GV03', 'Do Nghiem Phung', 'TS', 'GS', 'Nu', '1/8/1950', '23/9/2004', '4.00', '1,800,000', 'CNPM')							
INSERT INTO GIAOVIEN VALUES('GV04', 'Tran Nam Son', 'TS', 'PGS', 'Nam', '22/2/1961', '12/1/2005', '4.50', '2,025,000', 'KTMT')							
INSERT INTO GIAOVIEN VALUES('GV05', 'Mai Thanh Danh', 'ThS', 'GV', 'Nam', '12/3/1958', '12/1/2005', '3.00', '1,350,000', 'HTTT')							
INSERT INTO GIAOVIEN VALUES('GV06', 'Tran Doan Hung', 'TS', 'GV', 'Nam', '11/3/1953', '12/1/2005', '4.50', '2,025,000', 'KHMT')							
INSERT INTO GIAOVIEN VALUES('GV07', 'Nguyen Minh Tien', 'ThS', 'GV', 'Nam', '23/11/1971', '1/3/2005', '4.00', '1,800,000', 'KHMT')							
INSERT INTO GIAOVIEN VALUES('GV08', 'Le Thi Tran', 'KS', 'Null', 'Nu', '26/3/1974', '1/3/2005', '1.69', '760,5', 'KHMT')							
INSERT INTO GIAOVIEN VALUES('GV09', 'Nguyen To Lan', 'ThS', 'GV', 'Nu', '31/12/1966', '1/3/2005', '4.00', '1,800,000', 'HTTT')							
INSERT INTO GIAOVIEN VALUES('GV10', 'Le Tran Anh Loan', 'KS', 'Null', 'Nu', '17/7/1972', '1/3/2005', '1.86', '837', 'CNPM')							
INSERT INTO GIAOVIEN VALUES('GV11', 'Ho Thanh Tung', 'CN', 'GV', 'Nam', '12/1/1980', '15/5/2005', '2.67', '1,201,500', 'MTT')							
INSERT INTO GIAOVIEN VALUES('GV12', 'Tran Van Anh', 'CN', 'Null', 'Nu', '29/3/1981', '15/5/2005', '1.69', '760,5', 'CNPM')							
INSERT INTO GIAOVIEN VALUES('GV13', 'Nguyen Linh Dan', 'CN', 'Null', 'Nu', '23/5/1980', '15/5/2005', '1.69', '760,5', 'KTMT')							
INSERT INTO GIAOVIEN VALUES('GV14', 'Truong Minh Chau', 'ThS', 'GV', 'Nu', '30/11/1976', '15/5/2005', '3.00', '1,350,000', 'MTT')							
INSERT INTO GIAOVIEN VALUES('GV15', 'Le Ha Thanh', 'ThS', 'GV', 'Nam', '4/5/1978', '15/5/2005', '3.00', '1,350,000', 'KHMT'	)		

INSERT INTO KETQUATHI VALUES('K1101', 'CSDL', '1', '20/7/2006', '10.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1101', 'CTDLGT', '1', '28/12/2006', '9.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1101', 'THDC', '1', '20/5/2006', '9.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1101', 'CTRR', '1', '13/5/2006', '9.50', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'CSDL', '1', '20/7/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'CSDL', '2', '27/7/2006', '4.25', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'CSDL', '3', '10/8/2006', '4.50', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'CTDLGT', '1', '28/12/2006', '4.50', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'CTDLGT', '2', '5/1/2007', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'CTDLGT', '3', '15/1/2007', '6.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'THDC', '1', '20/5/2006', '5.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1102', 'CTRR', '1', '13/5/2006', '7.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1103', 'CSDL', '1', '20/7/2006', '3.50', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1103', 'CSDL', '2', '27/7/2006', '8.25', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1103', 'CTDLGT', '1', '28/12/2006', '7.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1103', 'THDC', '1', '20/5/2006', '8.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1103', 'CTRR', '1', '13/5/2006', '6.50', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1104', 'CSDL', '1', '20/7/2006', '3.75', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1104', 'CTDLGT', '1', '28/12/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1104', 'THDC', '1', '20/5/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1104', 'CTRR', '1', '13/5/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1104', 'CTRR', '2', '20/5/2006', '3.50', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1104', 'CTRR', '3', '30/6/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1201', 'CSDL', '1', '20/7/2006', '6.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1201', 'CTDLGT', '1', '28/12/2006', '5.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1201', 'THDC', '1', '20/5/2006', '8.50', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1201', 'CTRR', '1', '13/5/2006', '9.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1202', 'CSDL', '1', '20/7/2006', '8.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1202', 'CTDLGT', '1', '28/12/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1202', 'CTDLGT', '2', '5/1/2007', '5.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1202', 'THDC', '1', '20/5/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1202', 'THDC', '2', '27/5/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1202', 'CTRR', '1', '13/5/2006', '3.00', 'Khong Dat')		
INSERT INTO KETQUATHI VALUES('K1202', 'CTRR', '2', '20/5/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1202', 'CTRR', '3', '30/6/2006', '6.25', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1203', 'CSDL', '1', '20/7/2006', '9.25', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1203', 'CTDLGT', '1', '28/12/2006', '9.50', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1203', 'THDC', '1', '20/5/2006', '10.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1203', 'CTRR', '1', '13/5/2006', '10.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1204', 'CSDL', '1', '20/7/2006', '8.50', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1204', 'CTDLGT', '1', '28/12/2006', '6.75', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1204', 'THDC', '1', '20/5/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1204', 'CTRR', '1', '13/5/2006', '6.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1301', 'CSDL', '1', '20/12/2006', '4.25', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1301', 'CTDLGT', '1', '25/7/2006', '8.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1301', 'THDC', '1', '20/5/2006', '7.75', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1301', 'CTRR', '1', '13/5/2006', '8.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1302', 'CSDL', '1', '20/12/2006', '6.75', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1302', 'CTDLGT', '1', '25/7/2006', '5.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1302', 'THDC', '1', '20/5/2006', '8.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1302', 'CTRR', '1', '13/5/2006', '8.50', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1303', 'CSDL', '1', '20/12/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1303', 'CTDLGT', '1', '25/7/2006', '4.50', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1303', 'CTDLGT', '2', '7/8/2006', '4.00', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1303', 'CTDLGT', '3', '15/8/2006', '4.25', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1303', 'THDC', '1', '20/5/2006', '4.50', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1303', 'CTRR', '1', '13/5/2006', '3.25', 'Khong Dat')					
INSERT INTO KETQUATHI VALUES('K1303', 'CTRR', '2', '20/5/2006', '5.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1304', 'CSDL', '1', '20/12/2006', '7.75', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1304', 'CTDLGT', '1', '25/7/2006', '9.75', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1304', 'THDC', '1', '20/5/2006', '5.50', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1304', 'CTRR', '1', '13/5/2006', '5.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1305', 'CSDL', '1', '20/12/2006', '9.25', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1305', 'CTDLGT', '1', '25/7/2006', '10.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1305', 'THDC', '1', '20/5/2006', '8.00', 'Dat')					
INSERT INTO KETQUATHI VALUES('K1305', 'CTRR', '1', '13/5/2006', '10.00', 'Dat')					

INSERT INTO HOCVIEN VALUES('K1101', 'Nguyen Van', 'A', '27/1/1986', 'Nam', 'TpHCM', 'K11')						
INSERT INTO HOCVIEN VALUES('K1102', 'Tran Ngoc', 'Han', '14/3/1986', 'Nu', 'Kien Giang', 'K11')						
INSERT INTO HOCVIEN VALUES('K1103', 'Ha Duy', 'Lap', '18/4/1986', 'Nam', 'Nghe An', 'K11')						
INSERT INTO HOCVIEN VALUES('K1104', 'Tran Ngoc', 'Linh', '30/3/1986', 'Nu', 'Tay Ninh', 'K11')						
INSERT INTO HOCVIEN VALUES('K1105', 'Tran Minh', 'Long', '27/2/1986', 'Nam', 'TpHCM', 'K11')						
INSERT INTO HOCVIEN VALUES('K1106', 'Le Nhat', 'Minh', '24/1/1986', 'Nam', 'TpHCM', 'K11')						
INSERT INTO HOCVIEN VALUES('K1107', 'Nguyen Nhu', 'Nhut', '27/1/1986', 'Nam', 'Ha Noi', 'K11')						
INSERT INTO HOCVIEN VALUES('K1108', 'Nguyen Manh', 'Tam', '27/2/1986', 'Nam', 'Kien Giang', 'K11')						
INSERT INTO HOCVIEN VALUES('K1109', 'Phan Thi Thanh', 'Tam', '27/1/1986', 'Nu', 'Vinh Long', 'K11')						
INSERT INTO HOCVIEN VALUES('K1110', 'Le Hoai', 'Thuong', '5/2/1986', 'Nu', 'Can Tho', 'K11')						
INSERT INTO HOCVIEN VALUES('K1111', 'Le Ha', 'Vinh', '25/12/1986', 'Nam', 'Vinh Long', 'K11')						
INSERT INTO HOCVIEN VALUES('K1201', 'Nguyen Van', 'B', '11/2/1986', 'Nam', 'TpHCM', 'K12')						
INSERT INTO HOCVIEN VALUES('K1202', 'Nguyen Thi Kim', 'Duyen', '18/1/1986', 'Nu', 'TpHCM', 'K12')						
INSERT INTO HOCVIEN VALUES('K1203', 'Tran Thi Kim', 'Duyen', '17/9/1986', 'Nu', 'TpHCM', 'K12')						
INSERT INTO HOCVIEN VALUES('K1204', 'Truong My', 'Hanh', '19/5/1986', 'Nu', 'Dong Nai', 'K12')						
INSERT INTO HOCVIEN VALUES('K1205', 'Nguyen Thanh', 'Nam', '17/4/1986', 'Nam', 'TpHCM', 'K12')						
INSERT INTO HOCVIEN VALUES('K1206', 'Nguyen Thi Truc', 'Thanh', '4/3/1986', 'Nu', 'Kien Giang', 'K12')						
INSERT INTO HOCVIEN VALUES('K1207', 'Tran Thi Bich', 'Thuy', '8/2/1986', 'Nu', 'Nghe An', 'K12')						
INSERT INTO HOCVIEN VALUES('K1208', 'Huynh Thi Kim', 'Trieu', '8/4/1986', 'Nu', 'Tay Ninh', 'K12')						
INSERT INTO HOCVIEN VALUES('K1209', 'Pham Thanh', 'Trieu', '23/2/1986', 'Nam', 'TpHCM', 'K12')						
INSERT INTO HOCVIEN VALUES('K1210', 'Ngo Thanh', 'Tuan', '14/2/1986', 'Nam', 'TpHCM', 'K12')						
INSERT INTO HOCVIEN VALUES('K1211', 'Do Thi', 'Xuan', '9/3/1986', 'Nu', 'Ha Noi', 'K12')						
INSERT INTO HOCVIEN VALUES('K1212', 'Le Thi Phi', 'Yen', '12/3/1986', 'Nu', 'TpHCM', 'K12')						
INSERT INTO HOCVIEN VALUES('K1301', 'Nguyen Thi Kim', 'Cuc', '9/6/1986', 'Nu', 'Kien Giang', 'K13')						
INSERT INTO HOCVIEN VALUES('K1302', 'Truong Thi My', 'Hien', '18/3/1986', 'Nu', 'Nghe An', 'K13')						
INSERT INTO HOCVIEN VALUES('K1303', 'Le Duc', 'Hien', '21/3/1986', 'Nam', 'Tay Ninh', 'K13')						
INSERT INTO HOCVIEN VALUES('K1304', 'Le Quang', 'Hien', '18/4/1986', 'Nam', 'TpHCM', 'K13')						
INSERT INTO HOCVIEN VALUES('K1305', 'Le Thi', 'Huong', '27/3/1986', 'Nu', 'TpHCM', 'K13')						
INSERT INTO HOCVIEN VALUES('K1306', 'Nguyen Thai', 'Huu', '30/3/1986', 'Nam', 'Ha Noi', 'K13')						
INSERT INTO HOCVIEN VALUES('K1307', 'Tran Minh', 'Man', '28/5/1986', 'Nam', 'TpHCM', 'K13')						
INSERT INTO HOCVIEN VALUES('K1308', 'Nguyen Hieu', 'Nghia', '8/4/1986', 'Nam', 'Kien Giang', 'K13')						
INSERT INTO HOCVIEN VALUES('K1309', 'Nguyen Trung', 'Nghia', '18/1/1987', 'Nam', 'Nghe An', 'K13')						
INSERT INTO HOCVIEN VALUES('K1310', 'Tran Thi Hong', 'Tham', '22/4/1986', 'Nu', 'Tay Ninh', 'K13')						
INSERT INTO HOCVIEN VALUES('K1311', 'Tran Minh', 'Thuc', '4/4/1986', 'Nam', 'TpHCM', 'K13')						
INSERT INTO HOCVIEN VALUES('K1312', 'Nguyen Thi Kim', 'Yen', '7/9/1986', 'Nu', 'TpHCM', 'K13')
--CAU11
ALTER TABLE HOCVIEN
ADD CONSTRAINT HOCVIEN_NGSINH CHECK(YEAR(NGSINH) < 2004)
--CAU12
ALTER TABLE GIANGDAY
ADD CONSTRAINT GIANGDAY_TUNGAY_DENNGAY CHECK(DAY(TUNGAY) < DAY(DENNGAY))
--CAU13
ALTER TABLE GIAOVIEN
ADD CONSTRAINT GIAOVIEN_NGSING_NGVL CHECK((YEAR(NGSINH) - YEAR(NGVL)) > 21)
--CAU14
ALTER TABLE MONHOC
ADD CONSTRAINT MONHOC_TCLT_TCTH CHECK((TCLT - TCTT <= 3) OR (TCTT - TCLT <= 3))

--PHAN II QUAN LY GIAO VU

--CAU1
UPDATE GIAOVIEN SET HESO = HESO + HESO /(100/20)
WHERE MAGV IN (SELECT TRGKHOA FROM KHOA )
--CAU2
UPDATE HOCVIEN
SET DIEMTB = (SELECT AVG(DIEM) FROM KETQUATHI K1 WHERE LANTHI = (SELECT MAX(LANTHI) FROM KETQUATHI K2 WHERE (K1.MAHV = K2.MAHV AND K1.MAMH = K2.MAMH) GROUP BY MAHV,MAMH) 
              GROUP BY MAHV
              HAVING MAHV = HOCVIEN.MAHV)
SELECT * FROM HOCVIEN
--CAU3
 UPDATE HOCVIEN SET GHICHU = 'Cam thi' WHERE MAHV IN (SELECT MAHV FROM KETQUATHI WHERE LANTHI = 3 AND DIEM < 5) 
--CAU4
UPDATE HOCVIEN SET XEPLOAI = 
(
CASE
	WHEN DIEMTB >= 9 THEN  'XS'
	WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN  'G'
	WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN  'K'
	WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN 'TB'
	WHEN DIEMTB < 5 THEN 'Y'
END
)
--PHAN III QUAN LY GIAO VU

-- CAU1
SELECT MAHV, HO, TEN, NGSINH, B.MALOP
FROM HOCVIEN A, LOP B
WHERE A.MALOP = B.MALOP AND A.MAHV = B.TRGLOP
--CAU2
SELECT A.MAHV, LANTHI, DIEM, HO, TEN
FROM HOCVIEN A, KETQUATHI B
WHERE A.MAHV = B.MAHV AND MAMH = 'CTRR' AND A.MAHV LIKE 'K12%'
--CAU3
SELECT A.MAHV, HO, TEN,MAMH
FROM HOCVIEN A, KETQUATHI B
WHERE A.MAHV = B.MAHV AND LANTHI ='1' AND KQUA LIKE 'Dat' 
--CAU4
SELECT A.MAHV,HO, TEN
FROM HOCVIEN A, KETQUATHI B
WHERE A.MAHV = B.MAHV AND A.MAHV LIKE 'K11%' AND LANTHI='1' AND KQUA LIKE'Khong Dat' AND B.MAMH LIKE 'CTRR' 
--CAU5
SELECT DISTINCT HOCVIEN.MAHV, HO, TEN FROM HOCVIEN, KETQUATHI WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND MALOP LIKE 'K%' AND MAMH = 'CTRR'
AND NOT EXISTS (SELECT * FROM KETQUATHI WHERE KQUA = 'Dat' AND MAMH = 'CTRR' AND MAHV = HOCVIEN.MAHV)
--CAU6
SELECT TENMH
FROM MONHOC, GIAOVIEN, GIANGDAY
WHERE MONHOC.MAMH = GIANGDAY.MAMH AND GIAOVIEN.MAGV = GIANGDAY.MAGV AND HOTEN = 'Tran Tam Thanh' AND HOCKY = 1 AND NAM = 2006
--CAU7
SELECT MONHOC.MAMH, TENMH
FROM MONHOC, GIAOVIEN, GIANGDAY, LOP
WHERE MONHOC.MAMH = GIANGDAY.MAMH AND GIAOVIEN.MAGV = LOP.MAGVCN AND GIANGDAY.HOCKY = 1 AND GIANGDAY.NAM = 2006 AND LOP.MALOP = 'K11' AND GIAOVIEN.MAGV = GIANGDAY.MAGV
--CAU8
SELECT HO, TEN
FROM HOCVIEN, LOP, GIAOVIEN, MONHOC, GIANGDAY
WHERE GIAOVIEN.HOTEN = 'Nguyen To Lan' AND MONHOC.TENMH = 'Co So Du Lieu' AND HOCVIEN.MAHV = LOP.TRGLOP AND GIAOVIEN.MAGV = GIANGDAY.MAGV AND LOP.MALOP = GIANGDAY.MALOP
--CAU9
SELECT MONHOCTRUOC.MAMH, MONHOCTRUOC.TENMH
FROM MONHOC, MONHOC AS MONHOCTRUOC, DIEUKIEN
WHERE MONHOC.MAMH = DIEUKIEN.MAMH AND MONHOCTRUOC.MAMH = DIEUKIEN.MAMH_TRUOC AND DIEUKIEN.MAMH = 'CSDL'
--CAU10
SELECT MONHOC.MAMH, TENMH
FROM MONHOC, DIEUKIEN
WHERE MONHOC.MAMH = DIEUKIEN.MAMH AND DIEUKIEN.MAMH_TRUOC = 'CTRR'
--CAU11
SELECT GIAOVIEN.HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV AND GIANGDAY.MAMH = 'CTRR' AND GIANGDAY.HOCKY = 1 AND GIANGDAY.NAM = 2006 AND GIANGDAY.MALOP = 'K11'
INTERSECT
SELECT GIAOVIEN.HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV AND GIANGDAY.MAMH = 'CTRR' AND GIANGDAY.HOCKY = 1 AND GIANGDAY.NAM = 2006 AND GIANGDAY.MALOP = 'K12'
--CAU12
SELECT HOCVIEN.MAHV, HO, TEN 
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND MAMH = 'CSDL' AND LANTHI = 1 AND KQUA = 'Khong dat' AND NOT EXISTS (SELECT * FROM KETQUATHI WHERE LANTHI > 1 AND KETQUATHI.MAHV = HOCVIEN.MAHV)
--CAU13
SELECT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN
WHERE GIAOVIEN.MAGV NOT IN (SELECT GIAOVIEN.MAGV FROM GIAOVIEN, GIANGDAY WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV )
--CAU14
SELECT MAGV, HOTEN
FROM GIAOVIEN
WHERE NOT EXISTS(SELECT * FROM MONHOC WHERE MONHOC.MAKHOA = GIAOVIEN.MAKHOA AND NOT EXISTS
(SELECT * FROM GIANGDAY WHERE GIANGDAY.MAMH = MONHOC.MAMH AND GIANGDAY.MAGV = GIAOVIEN.MAGV))
--CAU15
SELECT HO, TEN
FROM HOCVIEN, KETQUATHI 
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND HOCVIEN.MALOP = 'K11'  AND LANTHI = 3 AND KQUA = 'Khong dat' 
UNION
SELECT HO, TEN
FROM HOCVIEN, KETQUATHI 
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV  AND HOCVIEN.MALOP = 'K11'  AND LANTHI = 2 AND KETQUATHI.MAMH = 'CTRR' AND KETQUATHI.DIEM = 5 
--CAU16
SELECT HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV AND GIANGDAY.MAMH = 'CTRR' GROUP BY GIAOVIEN.MAGV, HOTEN, HOCKY HAVING  COUNT(*) >= 2
--CAU17
SELECT HOCVIEN.*, DIEM as ' DIEM CSDL' FROM HOCVIEN, KETQUATHI WHERE KETQUATHI.MAHV = HOCVIEN.MAHV AND KETQUATHI.MAMH = 'CSDL' AND KETQUATHI.LANTHI =
	(SELECT MAX(LANTHI) FROM KETQUATHI WHERE KETQUATHI.MAMH = 'CSDL' AND KETQUATHI.MAHV = HOCVIEN.MAHV GROUP BY MAHV)
--CAU18
SELECT HOCVIEN.*, DIEM as 'DIEM CSDL' FROM HOCVIEN, KETQUATHI, MONHOC WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND KETQUATHI.MAMH = MONHOC.MAMH AND TENMH = 'Co so du lieu'
AND DIEM = 
(
	SELECT MAX(DIEM) 
	FROM KETQUATHI, MONHOC
	WHERE
		KETQUATHI.MAMH = MONHOC.MAMH
		AND MAHV = HOCVIEN.MAHV
		AND TENMH = 'Co so du lieu'
	GROUP BY MAHV
)
--CAU19
SELECT MAKHOA, TENKHOA
FROM KHOA 
WHERE NGTLAP = (SELECT MIN(NGTLAP) FROM KHOA)


--CAU20.
SELECT COUNT(*)SOLUONGGIAOVIEN
FROM GIAOVIEN
WHERE HOCHAM = 'GS' OR HOCHAM = 'PGS'

--CAU21
SELECT COUNT(*)SOLUONGGIAOVIEN
FROM GIAOVIEN
WHERE HOCVI = 'CN' OR HOCVI = 'KS' OR HOCVI = 'Ths' OR HOCVI = 'TS' OR HOCVI = 'PTS'

--CAU22
SELECT MAMH, KQUA, COUNT(*) SOHOCVIEN
FROM KETQUATHI
GROUP BY MAMH, KQUA

--CAU23
SELECT DISTINCT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN, LOP, GIANGDAY
WHERE GIAOVIEN.MAGV = LOP.MAGVCN AND GIAOVIEN.MAGV = GIANGDAY.MAGV AND GIANGDAY.MALOP = LOP.MALOP


--CAU24.
SELECT HO, TEN
FROM HOCVIEN, LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP AND SISO = (SELECT MAX(SISO) FROM LOP)

--CAU25.
SELECT HO, TEN
FROM HOCVIEN, LOP, KETQUATHI
WHERE HOCVIEN.MAHV = LOP.TRGLOP AND HOCVIEN.MAHV = KETQUATHI.MAHV AND KQUA = 'Khong Dat'
GROUP BY TRGLOP, HO, TEN
HAVING COUNT(*) > 3

--CAU26
SELECT HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND DIEM >= 9
GROUP BY HOCVIEN.MAHV, HO, TEN
ORDER BY COUNT(*) DESC

--CÂU27
SELECT LOP.MALOP,HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, LOP, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND HOCVIEN.MALOP = LOP.MALOP AND DIEM >= 9
GROUP BY  LOP.MALOP, HOCVIEN.MAHV, HO, TEN
ORDER BY COUNT(*) DESC



--CAU28
SELECT MAGV, COUNT(DISTINCT MAMH) 'Số môn học', COUNT(DISTINCT MALOP) 'Số lớp'
FROM GIANGDAY
GROUP BY MAGV

--CAU29
SELECT HOCKY, NAM, A.MAGV, HOTEN
FROM GIAOVIEN,(
	SELECT 
		HOCKY, NAM, MAGV, RANK() OVER (
			PARTITION BY HOCKY, NAM 
			ORDER BY COUNT(*) DESC
		) AS XEPHANG
	FROM GIANGDAY
	GROUP BY HOCKY, NAM, MAGV
	) AS A
WHERE A.MAGV = GIAOVIEN.MAGV AND XEPHANG = 1
ORDER BY NAM, HOCKY



--CAU30
SELECT TOP 1 MONHOC.MAMH, TENMH
FROM MONHOC, KETQUATHI 
WHERE MONHOC.MAMH = KETQUATHI.MAMH AND LANTHI = 1 AND KQUA = 'Khong Dat'
GROUP BY MONHOC.MAMH, TENMH
ORDER BY COUNT(*) DESC


--CAU31
SELECT DISTINCT
	HOCVIEN.MAHV, HO, TEN 
FROM
	HOCVIEN, KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KETQUATHI
		WHERE LANTHI = 1
		AND KQua = 'Khong Dat'
		AND MAHV = HOCVIEN.MAHV
	)


--CAU32
SELECT DISTINCT HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI 
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND NOT EXISTS 
(
	SELECT* 
	FROM KETQUATHI 
	WHERE LANTHI =
	(
		SELECT MAX(LANTHI) 
		FROM KETQUATHI 
		WHERE MAHV = HOCVIEN.MAHV 
		GROUP BY MAHV
	) 
	AND KQUA = 'Khong Dat' AND MAHV = HOCVIEN.MAHV
)



--CAU33
SELECT HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN
WHERE NOT EXISTS 
(
	SELECT * 
	FROM MONHOC
	WHERE NOT EXISTS (
		SELECT *
		FROM KETQUATHI
		WHERE MONHOC.MAMH = KETQUATHI.MAMH AND KETQUATHI.MAHV = HOCVIEN.MAHV AND
		KQUA = 'Dat' AND
		LANTHI = 1
	)
)

--CAU34
SELECT MAHV, HO, TEN
FROM HOCVIEN
WHERE NOT EXISTS (
	SELECT * 
	FROM MONHOC
	WHERE NOT EXISTS (
		SELECT *
		FROM KETQUATHI
		WHERE MONHOC.MAMH = KETQUATHI.MAMH AND
		KETQUATHI.MAHV = HOCVIEN.MAHV AND
		KQUA = 'Dat' AND
		LANTHI = (
			SELECT MAX(LANTHI) 
			FROM KETQUATHI K2
			WHERE K2.MAHV = HOCVIEN.MAHV
			GROUP BY MAHV
		)
	)
)

--CAU35
SELECT MAMH, MAHV, HOTEN
FROM
(
	SELECT MAMH, HOCVIEN.MAHV, (HO+' '+TEN) HOTEN, RANK() 
	OVER (
		PARTITION BY MAMH 
		ORDER BY MAX(DIEM) DESC
	) AS XEPHANG
	FROM HOCVIEN, KETQUATHI
	WHERE HOCVIEN.MAHV = KETQUATHI.MAHV AND LANTHI = (
		SELECT MAX(LanThi) 
		FROM KetQuaThi 
		WHERE MaHV = HocVien.MaHV 
		GROUP BY MaHV
	)
	GROUP BY MAMH, HOCVIEN.MAHV, HO, TEN
) AS A
WHERE XEPHANG = 1