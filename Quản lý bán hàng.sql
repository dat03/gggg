--QUAN LY BAN HANG
CREATE DATABASE QUAN_LY_BAN_HANG
use QUAN_LY_BAN_HANG;

--PHAN I QUAN LY BAN HANG
create table KHACH_HANG(
	MAKH char(4) PRIMARY KEY,
	HOTEN varchar(40) ,
	DIACHI varchar(50),
	SODT varchar(20),
	NGSINH smalldatetime,
	NGDK smalldatetime,
	DOANHSO money
);
create table NHAN_VIEN(
	MANV char(4) NOT NULL PRIMARY KEY,
	HOTEN varchar(40),
	SODT varchar(20),
	NGVL smalldatetime
);
create table SAN_PHAM(
	MASP char(4) NOT NULL PRIMARY KEY,
	TENSP varchar(40),
	DVT varchar(20),
	NUOCSX varchar(40),
	GIA money
);
create table HOA_DON(
	SOHD int NOT NULL PRIMARY KEY,
	NGHD smalldatetime,
	MAKH char(4) FOREIGN KEY REFERENCES KHACH_HANG(MAKH),
	MANV char(4)FOREIGN KEY REFERENCES NHAN_VIEN(MANV),
	TRIGIA money
);
create table CTHD(
	SOHD int FOREIGN KEY REFERENCES HOA_DON(SOHD),
	MASP char(4) FOREIGN KEY REFERENCES SAN_PHAM(MASP),
	SL int
);

--2.	Thêm vào thuộc tính GHICHU có kiểu dữ liệu varchar(20) cho quan hệ SANPHAM.

ALTER TABLE SAN_PHAM
ADD GHICHU varchar(20)

--3.	Thêm vào thuộc tính LOAIKH có kiểu dữ liệu là tinyint cho quan hệ KHACHHANG.

ALTER TABLE KHACH_HANG
ADD LOAIKH tinyint

--4.	Sửa kiểu dữ liệu của thuộc tính GHICHU trong quan hệ SANPHAM thành varchar(100).

ALTER TABLE SAN_PHAM
ALTER COLUMN GHICHU varchar(100)

--5.	Xóa thuộc tính GHICHU trong quan hệ SANPHAM.

ALTER TABLE SAN_PHAM
DROP COLUMN GHICHU

--6.	Làm thế nào để thuộc tính LOAIKH trong quan hệ KHACHHANG có thể lưu các giá trị là: “Vang lai”, “Thuong xuyen”, “Vip”…

ALTER TABLE KHACH_HANG
ALTER COLUMN LOAIKH VARCHAR(30)

--7: Đơn vị tính của sản phẩm chỉ có thể là (“cay”,”hop”,”cai”,”quyen”,”chuc”).

ALTER TABLE SAN_PHAM  
ADD CONSTRAINT SAN_PHAM_DVT CHECK (DVT = 'cay' OR DVT = 'hop' OR DVT = 'cai' OR DVT = 'quyen' OR DVT = 'chuc')

--8.	Giá bán của sản phẩm từ 500 đồng trở lên.

ALTER TABLE SAN_PHAM
ADD CONSTRAINT SAN_PHAM_GIA CHECK(GIA > 500)

--9.	Mỗi lần mua hàng, khách hàng phải mua ít nhất 1 sản phẩm.

ALTER TABLE HOA_DON
ADD CONSTRAINT HOA_DON_SOHD CHECK(SOHD > 1)

--10.	Ngày khách hàng đăng ký là khách hàng thành viên phải lớn hơn ngày sinh của người đó.
 ALTER TABLE KHACH_HANG
 ADD CONSTRAINT KHACH_HANG_NGDK CHECK(NGDK > NGSINH)

--11.Ngày mua hàng (NGHD) của một khách hàng thành viên sẽ lớn hơn hoặc bằng ngày khách hàng đó đăng ký thành viên (NGDK).
CREATE TRIGGER TRG_INS_HD ON HOA_DON
FOR INSERT
AS
BEGIN
	IF EXISTS(SELECT *
		FROM INSERTED, KHACH_HANG
		WHERE INSERTED.MAKH = KHACH_HANG.MAKH
		AND NGHD < NGDK)
	BEGIN
		RAISERROR('NGAY HOA DON KHONG HOP LE', 16, 1);
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT 'THEM MOT HOA DON THANH CONG'
	END
END

--12.	Ngày bán hàng (NGHD) của một nhân viên phải lớn hơn hoặc bằng ngày nhân viên đó vào làm.
CREATE TRIGGER TRG_INS_HD ON HOA_DON
FOR INSERT
AS
BEGIN
	IF EXISTS(SELECT *
		FROM INSERTED, NHAN_VIEN
		WHERE INSERTED.MANV = NHAN_VIEN.MANV
		AND NGHD < NGVL)
	BEGIN
		RAISERROR('LOI KHONG HOP LE', 16, 1);
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT 'THEM THANH CONG'
	END
END

--13.	Trị giá của một hóa đơn là tổng thành tiền (số lượng*đơn giá) của các chi tiết thuộc hóa đơn đó.
CREATE TRIGGER TRG_INS_HD ON HOA_DON
FOR INSERT
AS
BEGIN
	IF EXISTS(SELECT *
		FROM SAN_PHAM, INSERTED, CTHD
		WHERE INSERTED.SOHD = CTHD.SOHD
		AND TRIGIA != (CTHD.SOHD * GIA))
	BEGIN
		RAISERROR('LOI KHONG HOP LE',16 ,1);
		ROLLBACK TRANSACTION
	END
	ELSE
	BEGIN
		PRINT 'HOP LE'
	END
END

--14.	Doanh số của một khách hàng là tổng trị giá các hóa đơn mà khách hàng thành viên đó đã mua.

CREATE TRIGGER trg_upd_DS ON KHACH_HANG
FOR Update
AS
BEGIN
	DECLARE @TONGTRIGIA MONEY, @DOANHSO MONEY
	SELECT @TONGTRIGIA = SUM(TRIGIA)
	FROM HOA_DON, INSERTED
	WHERE HOA_DON.MAKH = INSERTED.MAKH
	SELECT @DOANHSO = DOANHSO FROM INSERTED
	IF (@DOANHSO <> @TONGTRIGIA)
	BEGIN
		PRINT('KHONG HOP LE');
		ROLLBACK TRANSACTION
	END
END


 SET DATEFORMAT DYM;
INSERT INTO NHAN_VIEN VALUES('NV01', 'Nguyen Nhu Nhut', '927345678','13/4/2006')							
INSERT INTO NHAN_VIEN VALUES('NV02', 'Le Thi Phi Yen', '987567390','21/4/2006')							
INSERT INTO NHAN_VIEN VALUES('NV03', 'Nguyen Van B', '997047382','27/4/2006')							
INSERT INTO NHAN_VIEN VALUES('NV04', 'Ngo Thanh Tuan', '913758498','24/6/2006')							
INSERT INTO NHAN_VIEN VALUES('NV05', 'Nguyen Thi Truc Thanh', '918590387','20/7/2006')							

INSERT INTO KHACH_HANG VALUES('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '08823451', '22/10/1960' ,'22/07/2006', '13,060,000')				
INSERT INTO KHACH_HANG VALUES('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '3/4/1974' ,'30/07/2006', '280,000')				
INSERT INTO KHACH_HANG VALUES('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '12/6/1980' ,'05/08/2006', '3,860,000')				
INSERT INTO KHACH_HANG VALUES('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '0917325476', '9/3/1965' ,'02/10/2006', '250,000')				
INSERT INTO KHACH_HANG VALUES('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '08246108', '10/3/1950' ,'28/10/2006', '21,000')				
INSERT INTO KHACH_HANG VALUES('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '31/12/1981' ,'24/11/2006', '915,000')				
INSERT INTO KHACH_HANG VALUES('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '6/4/1971' ,'01/12/2006', '12,500')				
INSERT INTO KHACH_HANG VALUES('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '0938435756', '10/1/1971' ,'13/12/2006', '365,000')				
INSERT INTO KHACH_HANG VALUES('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '08654763', '3/9/1979' ,'14/01/2007', '70,000')				
INSERT INTO KHACH_HANG VALUES('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '08768904', '2/5/1983' ,'16/01/2007', '67,500')				
			

INSERT INTO SAN_PHAM VALUES('BC01', 'But chi', 'cay', 'Singapore', '3000')				
INSERT INTO SAN_PHAM VALUES('BC02', 'But chi', 'cay', 'Singapore', '5000')				
INSERT INTO SAN_PHAM VALUES('BC03', 'But chi', 'cay', 'Viet Nam', '3500')				
INSERT INTO SAN_PHAM VALUES('BC04', 'But chi', 'hop', 'Viet Nam', '30000')				
INSERT INTO SAN_PHAM VALUES('BB01', 'But bi', 'cay', 'Viet Nam', '5000')				
INSERT INTO SAN_PHAM VALUES('BB02', 'But bi', 'cay', 'Trung Quoc', '7000')				
INSERT INTO SAN_PHAM VALUES('BB03', 'But bi', 'hop', 'Thai Lan', '100000')				
INSERT INTO SAN_PHAM VALUES('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', '2500')				
INSERT INTO SAN_PHAM VALUES('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', '4500')				
INSERT INTO SAN_PHAM VALUES('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', '3000')				
INSERT INTO SAN_PHAM VALUES('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', '5500')				
INSERT INTO SAN_PHAM VALUES('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', '23000')				
INSERT INTO SAN_PHAM VALUES('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', '53000')				
INSERT INTO SAN_PHAM VALUES('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', '34000')				
INSERT INTO SAN_PHAM VALUES('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', '40000')				
INSERT INTO SAN_PHAM VALUES('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', '55000')				
INSERT INTO SAN_PHAM VALUES('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', '51000')				
INSERT INTO SAN_PHAM VALUES('ST04', 'So tay', 'quyen', 'Thai Lan', '55000')				
INSERT INTO SAN_PHAM VALUES('ST05', 'So tay mong', 'quyen', 'Thai Lan', '20000')				
INSERT INTO SAN_PHAM VALUES('ST06', 'Phan viet bang', 'hop', 'Viet Nam', '5000')				
INSERT INTO SAN_PHAM VALUES('ST07', 'Phan khong bui', 'hop', 'Viet Nam', '7000')				
INSERT INTO SAN_PHAM VALUES('ST08', 'Bong bang', 'cai', 'Viet Nam', '1000')				
INSERT INTO SAN_PHAM VALUES('ST09', 'But long', 'cay', 'Viet Nam', '5000')				
INSERT INTO SAN_PHAM VALUES('ST10', 'But long', 'cay', 'Trung Quoc', '7000')				

INSERT INTO HOA_DON VALUES('1001','23/07/2006', 'KH01', 'NV01', '320000')						
INSERT INTO HOA_DON VALUES('1002','12/08/2006', 'KH01', 'NV02', '840000')						
INSERT INTO HOA_DON VALUES('1003','23/08/2006', 'KH02', 'NV01', '100000')						
INSERT INTO HOA_DON VALUES('1004','01/09/2006', 'KH02', 'NV01', '180000')						
INSERT INTO HOA_DON VALUES('1005','20/10/2006', 'KH01', 'NV02', '3800000')						
INSERT INTO HOA_DON VALUES('1006','16/10/2006', 'KH01', 'NV03', '2430000')						
INSERT INTO HOA_DON VALUES('1007','28/10/2006', 'KH03', 'NV03', '510000')						
INSERT INTO HOA_DON VALUES('1008','28/10/2006', 'KH01', 'NV03', '440000')						
INSERT INTO HOA_DON VALUES('1009','28/10/2006', 'KH03', 'NV04', '200000')						
INSERT INTO HOA_DON VALUES('1010','01/11/2006', 'KH01', 'NV01', '5200000')						
INSERT INTO HOA_DON VALUES('1011','04/11/2006', 'KH04', 'NV03', '250000')						
INSERT INTO HOA_DON VALUES('1012','30/11/2006', 'KH05', 'NV03', '21000')						
INSERT INTO HOA_DON VALUES('1013','12/12/2006', 'KH06', 'NV01', '5000')						
INSERT INTO HOA_DON VALUES('1014','31/12/2006', 'KH03', 'NV02', '3150000')						
INSERT INTO HOA_DON VALUES('1015','01/01/2007', 'KH06', 'NV01', '910000')						
INSERT INTO HOA_DON VALUES('1016','01/01/2007', 'KH07', 'NV02', '12500')						
INSERT INTO HOA_DON VALUES('1017','02/01/2007', 'KH08', 'NV03', '35000')						
INSERT INTO HOA_DON VALUES('1018','13/01/2007', 'KH08', 'NV03', '330000')						
INSERT INTO HOA_DON VALUES('1019','13/01/2007', 'KH01', 'NV03', '30000')						
INSERT INTO HOA_DON VALUES('1020','14/01/2007', 'KH09', 'NV04', '70000')						
INSERT INTO HOA_DON VALUES('1021','16/01/2007', 'KH10', 'NV03', '67500')						
INSERT INTO HOA_DON VALUES('1022','16/01/2007', 'Null', 'NV03', '7000')						
INSERT INTO HOA_DON VALUES('1023','17/01/2007', 'Null', 'NV01', '330000')						

INSERT INTO CTHD VALUES('1001', 'TV02', '10')		
INSERT INTO CTHD VALUES('1001', 'ST01', '5')		
INSERT INTO CTHD VALUES('1001', 'BC01', '5')		
INSERT INTO CTHD VALUES('1001', 'BC02', '10')		
INSERT INTO CTHD VALUES('1001', 'ST08', '10')		
INSERT INTO CTHD VALUES('1002', 'BC04', '20')		
INSERT INTO CTHD VALUES('1002', 'BB01', '20')		
INSERT INTO CTHD VALUES('1002', 'BB02', '20')		
INSERT INTO CTHD VALUES('1003', 'BB03', '10')		
INSERT INTO CTHD VALUES('1004', 'TV01', '20')		
INSERT INTO CTHD VALUES('1004', 'TV02', '10')		
INSERT INTO CTHD VALUES('1004', 'TV03', '10')		
INSERT INTO CTHD VALUES('1004', 'TV04', '10')		
INSERT INTO CTHD VALUES('1005', 'TV05', '50')		
INSERT INTO CTHD VALUES('1005', 'TV06', '50')		
INSERT INTO CTHD VALUES('1006', 'TV07', '20')		
INSERT INTO CTHD VALUES('1006', 'ST01', '30')		
INSERT INTO CTHD VALUES('1006', 'ST02', '10')		
INSERT INTO CTHD VALUES('1007', 'ST03', '10')		
INSERT INTO CTHD VALUES('1008', 'ST04', '8')		
INSERT INTO CTHD VALUES('1009', 'ST05', '10')		
INSERT INTO CTHD VALUES('1010', 'TV07', '50')		
INSERT INTO CTHD VALUES('1010', 'ST07', '50')		
INSERT INTO CTHD VALUES('1010', 'ST08', '100')		
INSERT INTO CTHD VALUES('1010', 'ST04', '50')		
INSERT INTO CTHD VALUES('1010', 'TV03', '100')		
INSERT INTO CTHD VALUES('1011', 'ST06', '50')		
INSERT INTO CTHD VALUES('1012', 'ST07', '3')		
INSERT INTO CTHD VALUES('1013', 'ST08', '5')		
INSERT INTO CTHD VALUES('1014', 'BC02', '80')		
INSERT INTO CTHD VALUES('1014', 'BB02', '100')		
INSERT INTO CTHD VALUES('1014', 'BC04', '60')		
INSERT INTO CTHD VALUES('1014', 'BB01', '50')		
INSERT INTO CTHD VALUES('1015', 'BB02', '30')		
INSERT INTO CTHD VALUES('1015', 'BB03', '7')		
INSERT INTO CTHD VALUES('1016', 'TV01', '5')		
INSERT INTO CTHD VALUES('1017', 'TV02', '1')		
INSERT INTO CTHD VALUES('1017', 'TV03', '1')		
INSERT INTO CTHD VALUES('1017', 'TV04', '5')		
INSERT INTO CTHD VALUES('1018', 'ST04', '6')		
INSERT INTO CTHD VALUES('1019', 'ST05', '1')		
INSERT INTO CTHD VALUES('1019', 'ST06', '2')		
INSERT INTO CTHD VALUES('1020', 'ST07', '10')		
INSERT INTO CTHD VALUES('1021', 'ST08', '5')		
INSERT INTO CTHD VALUES('1021', 'TV01', '7')		
INSERT INTO CTHD VALUES('1021', 'TV02', '10')		
INSERT INTO CTHD VALUES('1022', 'ST07', '1')		
INSERT INTO CTHD VALUES('1023', 'ST04', '6')	

set dateformat dmy;

--PHAN II QUAN LY BAN HANG

--CAU2
SELECT * INTO SAN_PHAM1 FROM SAN_PHAM
SELECT * INTO KHACH_HANG1 FROM KHACH_HANG

--CAU3
UPDATE SAN_PHAM1 SET GIA = GIA + GIA / (100 / 5)
WHERE NUOCSX = 'Thai Lan'

--CAU4

UPDATE SAN_PHAM1 SET GIA = GIA - GIA / (100/5)
WHERE NUOCSX = 'Trung Quoc' AND GIA <= 10000

--CAU5

UPDATE KHACH_HANG1 SET LOAIKH = 'Vip'
WHERE (YEAR(NGDK) < 2007 AND DOANHSO > 10000000) OR (YEAR(NGDK) >= 2007 AND DOANHSO >= 2000000)

--PHAN III QUAN LY BAN HANG
--CAU1
SELECT MASP,TENSP
FROM SAN_PHAM
WHERE NUOCSX = 'TRUNG QUOC'
--CAU2
SELECT MASP, TENSP
FROM SAN_PHAM
WHERE DVT = 'cay' or DVT = 'quyen'
--CAU3
SELECT MASP, TENSP
FROM SAN_PHAM
WHERE MASP LIKE 'B%01'
--CAU4
SELECT MASP, TENSP
FROM SAN_PHAM
WHERE NUOCSX = 'TRUNG QUOC' AND GIA BETWEEN 30000 AND 40000
--CAU5
SELECT MASP, TENSP
FROM SAN_PHAM 
WHERE (NUOCSX = 'TRUNG QUOC' OR NUOCSX = 'THAI LAN') AND GIA BETWEEN 30000 AND 40000
--CAU6
SELECT SOHD, TRIGIA
FROM HOA_DON
WHERE NGHD = '1/1/2007' OR NGHD = '2/1/2007'
--CAU7
SELECT SOHD, TRIGIA
FROM HOA_DON
WHERE MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007
ORDER BY NGHD ASC, TRIGIA DESC
--CAU8
SELECT A.MAKH, HOTEN
FROM HOA_DON A, KHACH_HANG B
WHERE A.MAKH = B.MAKH AND NGHD = '1/1/2007'
--CAU9
SELECT SOHD, TRIGIA
FROM HOA_DON A , NHAN_VIEN B
WHERE A.MANV = B.MANV AND NGHD = '28/10/2006' AND HOTEN = 'Nguyen Van B'
--CAU10
SELECT C.MASP, TENSP
FROM HOA_DON A, SAN_PHAM D, CTHD C, KHACH_HANG B
WHERE B.MAKH = A.MAKH AND A.SOHD = C.SOHD AND D.MASP = C.MASP AND HOTEN = 'Nguyen Van A' AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006
--CAU11
SELECT * FROM SAN_PHAM
SELECT SOHD
FROM CTHD
WHERE MASP = 'BB01' OR MASP = 'BB02'
--CAU12
SELECT SOHD
FROM CTHD
WHERE (MASP = 'BB01' OR MASP = 'BB02') AND SL BETWEEN 10 AND 20
--CAU13
SELECT SOHD
FROM CTHD
WHERE MASP = 'BB01' AND SL BETWEEN 10 AND 20
INTERSECT 
SELECT SOHD
FROM CTHD
WHERE MASP = 'BB02' AND SL BETWEEN 10 AND 20
--CAU14
SELECT SAN_PHAM.MASP, SAN_PHAM.TENSP
FROM SAN_PHAM
WHERE SAN_PHAM.NUOCSX = 'Trung Quoc' 
INTERSECT
SELECT SAN_PHAM.MASP, SAN_PHAM.TENSP
FROM SAN_PHAM, CTHD, HOA_DON 
WHERE CTHD.SOHD = HOA_DON.SOHD AND HOA_DON.NGHD = '1/1/2007'
--CAU15
SELECT MASP, TENSP
FROM SAN_PHAM
WHERE MASP NOT IN ( SELECT MASP FROM CTHD)
--CAU16
SELECT MASP, TENSP
FROM SAN_PHAM
WHERE MASP NOT IN (SELECT MASP FROM CTHD, HOA_DON WHERE YEAR(NGHD) = 2006 )
--CAU17
SELECT MASP, TENSP
FROM SAN_PHAM
WHERE NUOCSX = 'Trung Quoc' AND MASP NOT IN(SELECT MASP FROM CTHD, HOA_DON WHERE YEAR(NGHD) = 2006)
--CAU18
SELECT SOHD FROM HOA_DON WHERE NOT EXISTS ( SELECT * FROM SAN_PHAM WHERE NUOCSX = 'Singapore' AND NOT EXISTS (SELECT * FROM CTHD
WHERE CTHD.SOHD = HOA_DON.SOHD
AND CTHD.MASP = SAN_PHAM.MASP)
)

--CAU19
SELECT COUNT(*) AS 'SO HOA DON'
FROM HOA_DON
WHERE MAKH IS NULL

--CAU20
SELECT COUNT(*) AS 'SO SAN PHAM'
FROM HOA_DON
WHERE YEAR(NGHD) = 2006

--CAU21
SELECT MAX(TRIGIA) AS 'MAX HOA DON', MIN(TRIGIA) AS 'MIN HOA DON'
FROM HOA_DON
 
 --CAU22
 SELECT AVG(TRIGIA) AS 'TRI GIA TRUNG BINH'
 FROM HOA_DON
 WHERE YEAR(NGHD) = 2006

 --CAU23
 SELECT SUM(TRIGIA) AS'DOANH THU'
 FROM HOA_DON
 WHERE YEAR(NGHD) = 2006

 --CAU24
 SELECT MAX(TRIGIA)AS'MAX GIA 2006'
 FROM HOA_DON
 WHERE YEAR(NGHD) = 2006

 --CAU25
 SELECT HOTEN
 FROM KHACH_HANG, HOA_DON
 WHERE KHACH_HANG.MAKH = HOA_DON.MAKH AND YEAR(NGHD) = 2006 AND TRIGIA = (SELECT MAX(TRIGIA) FROM HOA_DON WHERE YEAR(NGHD) = 2006)

--CAU26
SELECT TOP 3 MAKH, HOTEN
FROM KHACH_HANG 
ORDER BY DOANHSO DESC

--CAU27
SELECT MASP, TENSP
FROM SAN_PHAM
WHERE GIA IN(SELECT TOP 3 GIA FROM SAN_PHAM ORDER BY GIA DESC)

--CAU28
SELECT MASP,TENSP
FROM SAN_PHAM 
WHERE NUOCSX = 'Thai Lan' AND GIA IN (SELECT TOP 3 GIA FROM SAN_PHAM ORDER BY GIA DESC)

--CAU29
SELECT MASP, TENSP
FROM SAN_PHAM 
WHERE NUOCSX = 'Trung Quoc' AND GIA IN (SELECT TOP 3 GIA FROM SAN_PHAM WHERE NUOCSX = 'Trung Quoc' ORDER BY GIA DESC )

--CAU30
SELECT TOP 3 *  FROM KHACH_HANG ORDER BY DOANHSO DESC

--CAU31
SELECT COUNT(*)
FROM SAN_PHAM
WHERE NUOCSX = 'Trung Quoc'

--CAU32
SELECT NUOCSX, COUNT(*) SOSP
FROM SAN_PHAM
GROUP BY NUOCSX

--CAU33
SELECT NUOCSX, MAX(GIA)AS'MAX GIA', MIN(GIA)AS'MIN GIA', AVG(GIA)AS'TB GIA'
FROM SAN_PHAM
GROUP BY NUOCSX

--CAU34
SELECT NGHD, SUM(TRIGIA) DOANHTHU
FROM HOA_DON
GROUP BY NGHD

--CAU35
SELECT SAN_PHAM.MASP, SUM(SL) SOLUONG
FROM SAN_PHAM, HOA_DON, CTHD
WHERE HOA_DON.SOHD = CTHD.SOHD AND SAN_PHAM.MASP = CTHD.MASP AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006
GROUP BY SAN_PHAM.MASP

--CAU36
SELECT MONTH(NGHD) THANG, SUM(TRIGIA) DOANHTHU
FROM HOA_DON 
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)

--CAU37
SELECT *
FROM HOA_DON
WHERE  HOA_DON.SOHD IN 
( SELECT SOHD FROM CTHD GROUP BY CTHD.SOHD HAVING COUNT(DISTINCT MASP) >= 4)

--CAU38
SELECT *
FROM HOA_DON
WHERE HOA_DON.SOHD IN (
SELECT SOHD
FROM CTHD, SAN_PHAM
WHERE CTHD.MASP = SAN_PHAM.MASP AND NUOCSX = 'Viet Nam' 
GROUP BY SOHD 
HAVING COUNT(DISTINCT CTHD.MASP) >= 3)

--CAU39
SELECT KHACH_HANG.MAKH, HOTEN
FROM KHACH_HANG, HOA_DON
WHERE KHACH_HANG.MAKH = HOA_DON.MAKH
GROUP BY KHACH_HANG.MAKH, HOTEN
HAVING COUNT(*) >= ALL (SELECT COUNT(*) FROM HOA_DON GROUP BY MAKH)

--CAU40
SELECT MONTH(NGHD)THANG
FROM HOA_DON
WHERE YEAR(NGHD) = 2006 
GROUP BY MONTH(NGHD)
HAVING SUM(TRIGIA) >= ALL(SELECT SUM(TRIGIA) FROM HOA_DON WHERE YEAR(NGHD) = 2006 GROUP BY MONTH(NGHD))

--CAU41 
SELECT SAN_PHAM.MASP, TENSP 
FROM SAN_PHAM, CTHD, HOA_DON
WHERE SAN_PHAM.MASP = CTHD.MASP AND HOA_DON.SOHD = CTHD.SOHD AND YEAR(NGHD) = 2006
GROUP BY SAN_PHAM.MASP, TENSP
ORDER BY SUM(SL)

--CAU42
SELECT NUOCSX, MASP, TENSP
FROM SAN_PHAM SP1
WHERE EXISTS
(
	SELECT NUOCSX
	FROM SAN_PHAM SP2
	GROUP BY NUOCSX
	HAVING SP1.NUOCSX = SP2.NUOCSX
	AND SP1.GIA = MAX(GIA)
)

--CAU43
SELECT NUOCSX 
FROM SAN_PHAM 
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GIA) >= 3

--CAU44
SELECT *
FROM KHACH_HANG
WHERE MAKH IN
(
	SELECT TOP 1 WITH TIES HOA_DON.MAKH
	FROM (SELECT TOP 10 MAKH FROM KHACH_HANG ORDER BY DOANHSO DESC) AS A
	JOIN HOA_DON ON A.MaKH = HOA_DON.MAKH
	GROUP BY HOA_DON.MAKH
	ORDER BY COUNT(*) DESC
)